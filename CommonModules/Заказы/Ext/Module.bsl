
// DEPRECATED!                 
// DO NOT USE!
Процедура ОформитьЗаказДляПользователя(UserId) Экспорт
    // 1. Получаем все записи корзины
    Запрос = Новый Запрос;
    Запрос.Текст =
    "ВЫБРАТЬ
    |   Корзина.Артикул       КАК Артикул,
    |   Корзина.Количество    КАК Количество
    |ИЗ
    |   Справочник.КорзинаПользователей КАК Корзина
    |ГДЕ
    |   Корзина.Пользователь = &Пользователь";
    Запрос.УстановитьПараметр("Пользователь", UserId);

    Выборка = Запрос.Выполнить().Выбрать();

    // 2. Создаём документ «ЗаказКлиента»
    Заказ = Документы.ЗаказКлиента.СоздатьДокумент();
    // тут можно заполнить реквизиты заказа (дату, контрагента и т.п.)
    // Заказ.Дата       = ТекущаяДата();
    // Заказ.Контрагент = ...  

    Пока Выборка.Следующий() Цикл
        Строка = Заказ.Товары.Добавить();
        // Товар ищем по артикулу в справочнике
        Номенклатура = Справочники.Номенклатура.НайтиПоАртикулу(Выборка.Артикул);
        Если Не Номенклатура = Неопределено Тогда
            Строка.Номенклатура = Номенклатура;
            Строка.Количество   = Выборка.Количество;
        Иначе
            // можно обработать ситуацию «товар не найден»
        КонецЕсли;
    КонецЦикла;

    // 3. Записываем документ заказа
    Заказ.Записать();

    // 4. Очищаем корзину пользователя
    Корзина.УдалитьЗаписиКорзины(UserId);

КонецПроцедуры

Функция ПолучитьТекстЗаказов(from_id) Экспорт 
    // 1. Собираем данные из документов «ЗаказыПользователейВК»
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |   Заказ.Ссылка           КАК Ссылка,
    |   Заказ.Номер            КАК Номер,
    |   Заказ.Дата             КАК Дата,
	|   Заказ.Email            КАК Email,
	|   Заказ.Статус           КАК Статус
	|ИЗ
    |   Документ.ЗаказыПользователейВК КАК Заказ
    |ГДЕ
    |   Заказ.UserID = &Пользователь
    |УПОРЯДОЧИТЬ ПО
    |   Заказ.Дата УБЫВ";
    Запрос.УстановитьПараметр("Пользователь", Строка(from_id));
	Выборка = Запрос.Выполнить().Выбрать();

    // 2. Подготовим переменные
    Текст        = "";
    КоличЗаказов = 0;

    // 3. Обходим каждый найденный документ
    Пока Выборка.Следующий() Цикл
        КоличЗаказов = КоличЗаказов + 1;

        СсылкаДок  = Выборка.Ссылка;
        НомерДок   = Выборка.Номер;
        ДатаДок    = Формат(Выборка.Дата, "ДФ=dd.MM.yyyy");

        // Заголовок каждого заказа
        Если КоличЗаказов = 1 Тогда
            Текст = "Ваши заказы:" + Символы.ПС;
        КонецЕсли;

        Текст = Текст +
            Строка(КоличЗаказов) + ". Заказ №" + Строка(НомерДок) +
            " от " + ДатаДок + Символы.ПС; 

        // 3.1. Состав заказа
        Док        = СсылкаДок.ПолучитьОбъект();
        ТабЧасть   = Док.СоставЗаказа;
        СуммаВсего = 0;

        Для каждого Стр Из ТабЧасть Цикл
            Назв  = Стр.Номенклатура.Наименование;
            Кол   = Стр.Количество;
            Цена  = ?(Стр.Цена <> Неопределено, Стр.Цена, 0);
            Подит = Цена * Кол;
            СуммаВсего = СуммаВсего + Подит;

            Текст = Текст +
                " • " + Назв +
                " — " + Строка(Кол) + " шт." +
                " × " + Формат(Цена, "ЧДЦ=2") + "₽" +
                " = " + Формат(Подит, "ЧДЦ=2") + "₽" + Символы.ПС;
        КонецЦикла;

        // 3.2. Итого по документу
        Текст = Текст +
            "Сумма заказа: " + Формат(СуммаВсего, "ЧДЦ=2") + "₽" + Символы.ПС;    
		Текст = Текст + "Статус заказа: "+ Док.Статус + Символы.ПС + Символы.ПС;
    КонецЦикла;

    // 4. Если ни одного заказа не найдено
    Если КоличЗаказов = 0 Тогда
        Возврат "У вас нет оформленных заказов.";
    КонецЕсли;

    Возврат Текст;
КонецФункции

// 1. Создать заказ по корзине пользователя
Процедура СоздатьЗаказ(FromID, Email) Экспорт
    // 1.1. Получим из корзины массив структур { Артикул, Количество }
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |   Корзина.Артикул КАК Артикул,
    |   Корзина.Количество КАК Количество
    |ИЗ
    |   Справочник.КорзинаПользователей КАК Корзина
    |ГДЕ
    |   Корзина.Пользователь = &Пользователь";
    Запрос.УстановитьПараметр("Пользователь", Строка(FromID));
    Результат = Запрос.Выполнить().Выбрать();

    // Если корзина пуста — ничего не делаем
	Если НЕ Результат.Следующий() Тогда 
	Иначе
        // 1.2. Создаём сам документ
	    Док = Документы.ЗаказыПользователейВК.СоздатьДокумент();      // <- ваше имя документа
	    Док.Дата   = ТекущаяДата(); 
	    Док.UserID = FromID; // реквизит «Пользователь» у документа
        Док.Email  = Email;  
		Док.Статус = "В обработке";  
		
		ОбработатьСтрокуКорзины(Результат, Док);
	    // 1.3. Добавляем табличную часть "Товары"
	    Пока Результат.Следующий() Цикл         
			ОбработатьСтрокуКорзины(Результат, Док);	        
	    КонецЦикла;

	    // 1.4. Записываем документ
	    Док.Записать();

	    // очищаем корзину пользователя
	    ОчиститьКорзину(FromID);
    КонецЕсли;

КонецПроцедуры

Процедура ОбработатьСтрокуКорзины(Результат, Док)
	Артикул  = Результат.Артикул;
	Колво    = Результат.Количество;

	// Найдём ссылку на номенклатуру
	СсылкаНом = Каталог.НайтиПоАртикулу(Артикул);
	Если СсылкаНом <> Неопределено Тогда
		Строка = Док.СоставЗаказа.Добавить();  // «Товары» – код табличной части
	    Строка.Номенклатура = СсылкаНом;
	    Строка.Количество   = Колво;   
		ЦенаТовара = Каталог.ПолучитьЦену(СсылкаНом);
        Строка.Цена = ЦенаТовара;   
		
	КонецЕсли;	
КонецПроцедуры

// 2. Утилита: очистить корзину
Процедура ОчиститьКорзину(FromID)
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ
    |   Корзина.Ссылка КАК Ссылка
    |ИЗ
    |   Справочник.КорзинаПользователей КАК Корзина
    |ГДЕ
    |   Корзина.Пользователь = &Пользователь";
    Запрос.УстановитьПараметр("Пользователь", Строка(FromID));

    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        СсылкаЭлемента = Выборка.Ссылка;
		ОбъектЭлемента = СсылкаЭлемента.ПолучитьОбъект();
		ОбъектЭлемента.Удалить();
    КонецЦикла;
КонецПроцедуры